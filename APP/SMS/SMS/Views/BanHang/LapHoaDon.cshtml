@{
    ViewBag.Title = "Lập hóa đơn bán hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/LapHoaDon.css" rel="stylesheet" />

<h2>@ViewBag.Title</h2>
@section Scripts
{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/jqueryui")
    @Styles.Render("~/Content/themes/base/css")
<link href="../../Content/css/sunny/jquery-ui-1.10.3.custom.css" rel="stylesheet" type="text/css" />
<script src="../../Content/js/jquery-1.9.1.js" type="text/javascript"></script>
<script src="../../Content/js/jquery-ui-1.10.3.custom.js" type="text/javascript"></script>

<script>
    $(document).ready(function () {
        //show calendar
        $('.datePicker').datepicker({
            dateFormat: 'dd/mm/yy',
            changeMonth: true,
            changeYear: true,
            yearRange: "-60:+0"
        });
        // hide relation product
        hideRelationProduct();

        //set default value
        $('#typeCustomers').attr("disabled", "disabled");
        //initial combobox store
        $('#typeStore').html(createStore());
        /*disabled export excel*/
        $('#exportExcel').attr("disabled", "disabled");
        $('#exportExcel').css("background-color", "#ECECEC");

        /**AUTOCOMPLETE**/
        $("#TenSanPham").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/SanPham/FindSuggestByTypeCustomer", data: "{ 'prefixText': '" + request.term + "' , 'typeCustomer' : '" + $("input[type='radio']:checked").val() + "'}",
                    dataType: "json", type: "POST", contentType: "application/json; charset=utf-8",
                    dataFilter: function (data) { return data; }, success:
                        function (data) {
                            response($.map(data, function (item) {
                                return {
                                    lable : item.name,                                   
                                    value: item.name,
                                    id: item.id,
                                    price: item.price,
                                    discount:item.discount
                                }
                            }))
                        }, error: function (XMLHttpRequest, textStatus, errorThrown) { alert(textStatus); }
                });
            },
            select: function (event, ui) {
                $('#relationProduct').removeClass('relationProductShow');
                $('#relationProduct').addClass('relationProductHide');

                setFixedField(ui.item);
                return false;
            },
            focus: function (event, ui) {
              
                setRelationProduct(ui.item);
                $('#relationProduct').removeClass('relationProductHide');
                $('#relationProduct').addClass('relationProductShow');
            },
            close: function () {
                hideRelationProduct();
            },
            minLength: 1

        }).keyup(function (e) {
            if (e.which === 13 || e.which === 27) {
                $(".ui-menu-item").hide();
                $('#relationProduct').removeClass('relationProductShow');
                $('#relationProduct').addClass('relationProductHide');
            }
        });;

        //format numberic start 
        formatNumberic();
        $('input.numberic').keypress(function (key) {
            var keycode = (key.which) ? key.which : key.keyCode;
            //comparing pressed keycodes

            if (keycode > 31 && (keycode < 48 || keycode > 57) && keycode != 46) {
                //alert(" Hãy nhập ký tự số.");
                return false;
            }
            else return true;

        });
        $('input.numberic').keyup(function (event) {
            // skip for arrow keys
            if (event.which >= 37 && event.which <= 40) {
                //event.preventDefault();
                return true;
            }
            FormatNumberic_KeyUp($(this));

        });
        $('input.numberic').bind("paste", function (e) {
            e.preventDefault();
        });
        //format numberic end
    });
function hideRelationProduct(){
            // hide relation product
    $('#relationProduct').removeClass('relationProductShow');
    $('#relationProduct').addClass('relationProductHide');
}
function addCommaNumberic(ctrlID) {
    $(ctrlID).val($(ctrlID).val().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
}
function saveCurrentType() {
    var selected = $("input[type='radio']:checked");
    if (selected.length > 0) {
        $('#currTypeCustomer').val(selected.val());
    }
}
function changeTypeCustomer(value) {
    var selected = $("input[type='radio']:checked");
    if (selected.length > 0) {
        if(selected.val() == '1'){
            $('#typeCustomers').attr("disabled", "disabled");
        } else {
            $('#typeCustomers').removeAttr("disabled", "disabled");
        }
        
    }
}
function setFixedField(item) {
    CalcRealPrice(item.price, item.discount);
    addCommaNumberic('#GiaThuc');
    $('#MaSanPham').val(item.id);
    $('#TenSanPham').val(item.label);
    $('#GiaBan').val(item.price);
    addCommaNumberic('#GiaBan');
    $('#ChietKhau').val(item.discount);
    addCommaNumberic('#ChietKhau');
}
function setRelationProduct(item) {

    setFixedField(item);

    $('#S_MaSanPham').html(item.id);
    $('#S_TenSanPham').html(item.label);
    $('#S_GiaBan').html($('#GiaBan').val());
    $('#S_ChietKhau').html($('#ChietKhau').val());
    $('#S_GiaThuc').html($('#GiaThuc').val());
    //TODO :
}
function createStore() {
    var result = '';
    $.ajax({
        url: "/BanHang/FindStore",
        //data: "{ 'prefixText': '" + request.term + "' , 'typeCustomer' : '" + $("input[type='radio']:checked").val() + "'}",
        dataType: "json", type: "POST", contentType: "application/json; charset=utf-8",
        success:
            function (data) {
                $.each(data,function(i,item)
                {
                    var opt = "<option value=" + item.value + ">" + item.name + "</option>"
                    $(opt).appendTo('#typeStore');
                });
                }, 
        error: 
            function (XMLHttpRequest, textStatus, errorThrown) { alert(textStatus); }
    });
}

function fnOpenNormalDialog(title, content, action) {
    if ($("table.tableContentScroll tr").length == 0) {
        return;
    }

    $("#dialogConfirm").html(content);
    switch(action)
    {
        case 1:  // change type customer
            $("#dialogConfirm").dialog({
                resizable: false,
                modal: true,
                title: title,
                height: 200,
                width: 550,
                buttons: {
                    "Đồng ý": function () {
                        $(this).dialog('close');
                        callback(true);
                    },
                    "Không": function () {
                        $(this).dialog('close');
                        callback(false);
                    }
                }
            });
            break;
        case 2: // duplicate product item
            $("#dialogConfirm").dialog({
                resizable: false,
                modal: true,
                title: title,
                height: 200,
                width: 550,
                buttons: {
                    "Đóng": function () {
                        $(this).dialog('close');
                        $('#tableSearch #TenSanPham').select();
                    }
                }
            });
            break
        default:
            break;
    }
}


function callback(valueReturn) {
    if (valueReturn) {
        $("table.tableContentScroll tr").remove();
        $('#exportExcel').attr("disabled", "disabled");
        $('#exportExcel').css("background-color", "#ECECEC");
    } else {
        $('input:radio[value="' + $('#currTypeCustomer').val() + '"]').prop('checked', true);
    }
}
    

function addRecord() {
    if ($('#tableSearch #MaSanPham').val() != '') {
        if ($('#tableContent input:hidden[value="' + $('#tableSearch #MaSanPham').val() + '"]').length > 0){
            var title = "Xác nhận"
            var content = "Đã tồn tại sản phẩm này trong danh sách bên dưới.<br/> Hãy kiểm tra lại danh sách bên dưới hoặc thêm sản phẩm khác ";
            var action = 2;
            $('#addRecord').click(fnOpenNormalDialog(title, content, action));
        } else {
            prependNewRowToTable();
            $('#exportExcel').removeAttr("disabled", "disabled");
            $('#exportExcel').css("background-color", "");
        }
    }

}
function prependNewRowToTable() {
    var MaSP = $('#tableSearch #MaSanPham').val();
    var TenSP = $('#tableSearch #TenSanPham').val();
    var newRow = '';
    newRow += ' <tr class="rowHeight" id=\'' + MaSP + '\'> ';
    newRow += '<td style="width:20px;"> ';
    newRow += '  <div class="colDelete">';
    newRow += '  <img src="/Content/images/delete-20.png" style="cursor: pointer;" onclick="deleteRow(\'' + $('#tableSearch #MaSanPham').val() + '\');">';
    newRow += '   </div>';
    newRow += ' </td> ';
    newRow += ' <td  class="colProductNm textLeft"> ';
    newRow += ' <div  class="colProductNm tooltip truncate">';
    newRow += TenSP;
    newRow += '  <span>' + TenSP + '</span>';
    newRow += '  <input name="' + MaSP + '" type="hidden" value="' + MaSP + '" />';
    newRow += '  <input name="TenSanPham_' + MaSP + '" type="hidden" value="' + TenSP + '" />';
    newRow += '   </div>';
    newRow += ' </td> ';
    newRow += ' <td class="colPrice textRight"> ';
    newRow += $('#tableSearch #GiaBan').val();
    newRow += '  <input name="GiaBan_' + MaSP + '" type="hidden" value="' + $('#tableSearch #GiaBan').val() + '" />';
    newRow += ' </td> ';
    newRow += '  <td  class="colDiscount textRight"> ';
    newRow += $('#tableSearch #ChietKhau').val();
    newRow += '  <input name="ChietKhau_' + MaSP + '" type="hidden" value="' + $('#tableSearch #ChietKhau').val() + '" />';
    newRow += ' </td>  ';
    newRow += '  <td class="colRealPrice textRight"> ';
    newRow += $('#tableSearch #GiaThuc').val();
    newRow += '  <input name="GiaThuc_' + MaSP + '" type="hidden" value="' + $('#tableSearch #GiaThuc').val() + '" />';
    newRow += ' </td> ';
    newRow += '  </tr> ';
    $('#tableContent').prepend(newRow);
    //reset value
    $('#tableSearch #TenSanPham').val('')
    $('#tableSearch #MaSanPham').val('')
    $('#tableSearch #GiaBan').val('')
    $('#tableSearch #ChietKhau').val('')
    $('#tableSearch #GiaThuc').val('')
}
function CalcRealPrice(price, discount) {
    if (price == 0 || discount == 0) {
        $('#tableSearch #GiaThuc').val(price);
    } else {
        $('#tableSearch #GiaThuc').val(roundToTwo(price - ((price * discount) / 100)));
    }
    
}
function roundToTwo(num) {
    return +(Math.round(num + "e+2") + "e-2");
}
function UpdateRealPrice() {
    if ('' == $('#MaSanPham').val() || null == $('#MaSanPham').val()) {
        return
    }
    var price = removeCommas($('#GiaBan').val());
    var discount = removeCommas($('#ChietKhau').val());
    if (null == price ){
        price = 0;
        $('#GiaBan').val('0');
    }
    if (null == discount) {
        discount = 0;
        $('#ChietKhau').val('0');
    }
    CalcRealPrice(price, discount);
    addCommaNumberic('#GiaThuc');
}

/*remove comma from value input*/
function removeCommas(str) {
    if (str != null && str != '') {
        return (str.replace(/,/g, ''));
    } else {
        return null;
    }

}
function deleteRow(rowId) {
    $('#' + rowId).remove();
    if ($("table.tableContentScroll tr").length == 0) {
        $('#exportExcel').attr("disabled", "disabled");
        $('#exportExcel').css("background-color", "#ECECEC");
    } else {
        $('#exportExcel').removeAttr("disabled", "disabled");
        $('#exportExcel').css("background-color", "");
        
    }
}

function exportExcel() {

    var listProductNo = '';
    var indx = 0;
    $('#tableContent tr').each(function () {
        listProductNo +=  this.id
        if (indx < ($('#tableContent tr').length -1)) {
            listProductNo += ','
        }
        indx += 1; 
    })

    $('#ListProductID').val(listProductNo);
    $('#formContent').submit();
  
}

/*start format numberic*/
function NumbericOnly(ctrl) {
    $(ctrl).keypress(function (e) {

        //getting key code of pressed key
        var keycode = (e.which) ? e.which : e.keyCode;
        //comparing pressed keycodes

        if (keycode > 31 && (keycode < 48 || keycode > 57) && keycode != 46) {
            //alert("Hãy nhập ký tự số.");
            return false;
        }
        else return true;
    });

}
function formatNumberic() {
    $('input.numberic').each(function () {
        $(this).val($(this).val().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
    });
}

function FormatNumberic_KeyUp(obj) {
    var $this = $('#' + obj.id);
    var AmountWithCommas = $this.val();
    var DecimalSeparator = Number("1.2").toLocaleString().substr(1, 1);
    var arParts = String(AmountWithCommas).split(DecimalSeparator);

    var intPart = arParts[0];
    var decPart = (arParts.length > 1 ? arParts[1] : '');

    var num = intPart.replace(/,/gi, "").split("").reverse().join("");
    var num2 = RemoveRougeChar(num.replace(/(.{3})/g, "$1,").split("").reverse().join(""));
    if (decPart.length > 2) {
        decPart = (decPart + '00').substr(0, 2);
    }
    if (arParts.length > 1) {
        $this.val(num2 + DecimalSeparator + decPart);
    } else {
        $this.val(num2);
    }
}

function RemoveRougeChar(convertString) {
    if (convertString.substring(0, 1) == ",") {
        return convertString.substring(1, convertString.length)
    }
    return convertString;
}
/*end format numberic*/
</script>
}
<hr />
<div>
    <span style="font-size:16px;">> Loại khách hàng : </span>
    <br />

    <div style="margin-left: 45px;">
        <input type="radio" name="groupcustomer" id="Type1" checked="checked" value="1" onchange="changeTypeCustomer();">
        <span style="font-size:15px;"> Khách hàng vãng lai</span>
   

        <input type="radio" name="groupcustomer" id="Type2" value="2" onchange="changeTypeCustomer();">
        <span style="font-size:15px;"> Khách hàng trong danh mục</span>

    <select id="typeCustomers"  class="Combobox">
        <option value="1"> Khách hàng công ty , công trình</option>
        <option value="2"> Khách hàng thân thiết</option>
        <option value="2"> Khách hàng thường</option>
    </select>
   
</div>
<div>
    <span style="font-size:16px;">> Chọn kho hàng : </span>
    <select id="typeStore" class="Combobox">      
    </select>
</div>
    <div>
        <table id="tableSearch" class="tableSearch">
            <tr>
                <td >
                    <input type="hidden" id="MaSanPham" />
                    <div class="titleSanPham">Tên sản phẩm </div>
                    <br />
                    <div>
                        <input type="text" id="TenSanPham" style="margin-left: 2px; " />
                    </div>
</td>
                <td >
                    <div class="titleGiaBan">Giá bán</div>
                    <br />
                    <div>
                        <input type="text" id="GiaBan" maxlength="10" onblur="return UpdateRealPrice();"
                        class="numberic alignNumberic" onkeydown="NumbericOnly(this);" onkeyup="FormatNumberic_KeyUp(this);"
                        />
                    </div>
                    <div id="relationProduct">
                        <div>
                            <span><strong>- Mã sản phẩm : </strong> </span><span id="S_MaSanPham"></span>
                            <br />
                            <span><strong>- Tên sản phẩm : </strong> </span><span id="S_TenSanPham"></span>
                            <br />
                            <span><strong>- Giá bán : </strong> </span><span id="S_GiaBan"></span>
                            <br />
                            <span><strong>- Chiết khấu : </strong> </span><span id="S_ChietKhau"></span>
                            <br />
                            <span><strong>- Giá sau chiết khấu : </strong> </span><span id="S_GiaThuc"></span>
                            <br />
                            <span><strong>- Số lượng: </strong> </span>
                            <br />
                            <span><strong>  + Cửa hàng 1: </strong> </span><span> 10 </span>
                            <br />
                            <span><strong>  + Cửa hàng 2: </strong> </span><span> 12 </span>
                            <br />
                            <span><strong>  + Cửa hàng 3: </strong> </span><span> 14 </span>
                        </div>
                    </div>
                </td>
                <td >
                    <div class="titleChietKhau">Chiết khấu</div>
                    <br />
                    <div>
                        <input type="text" id="ChietKhau" maxlength="5" onblur="return UpdateRealPrice();"
                               class="numberic" onkeydown="NumbericOnly(this);" onkeyup="FormatNumberic_KeyUp(this);"
                               style="text-align: right; width: 110px !important;" />
                    </div>
                </td>
                <td>
                    <div class="titleGiaBan">Giá sau chiết khấu </div>
                    <br />
                    <div>
                        <input type="text" id="GiaThuc" maxlength="10"
                               style=" text-align:right;background: rgb(252, 252, 252);" readonly />
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="titleGiaBan">Số lượng</div>
                    <br />
                    <div>
                        <input type="text" id="SoLuong" maxlength="5"
                                class="alignNumberic" />
                    </div>
                </td>
                <td>
                    <div class="titleGiaBan">Ngày bán</div>
                    <br />
                    <div>
                        <input type="text" id="NgayBan" maxlength="10"
                               class="datePicker alignCenter " />
                    </div>
                </td>
                <td colspan="2">
                    <div class="titleGiaBan">Ngày giao hàng</div>
                    <br />
                    <div>
                        <input type="text" id="NgayGiao" maxlength="10"
                               class="datePicker alignCenter" />
                    </div>
                </td>
               
            </tr>
            <tr>
                <td colspan="3">
                    <div class="titleGiaBan">Địa chỉ giao hàng</div>
                    <br />
                    <div>
                        <textarea id="DiaChi" rows="3" cols="3" class="alignText" maxlength="300"></textarea>
                    </div>
                </td>
            </tr>
</table>
        <div class="myAction">
            <input type="button" id="addRecord" onclick="addRecord();" value="Thêm sản phẩm"/>
        </div>
    </div>



    <div id="dialogConfirm"></div>
    <input type="hidden" id="currTypeCustomer" />
</div>
<div class="mainContainer">
    <table class="tableHeader">     
        <tbody>
            <tr >
                <th style="width: 23px; padding: 0.5em 0em 0em 0em !important; ">
                    <div class="colDelete">
                        <img src="/Content/images/delete-20.png" style="display:none;">
                    </div>
                </th>
                <th class="colProductNmHeader">
                    <div class="colProductNmHeader">
                        Tên sản phẩm
                    </div>
                </th>
                <th class="colPriceHeader">
                    Giá bán
                </th>
                <th class="colDiscountHeader">
                    Chiết khấu (%)
                </th>
                <th class="colRealPriceHeader">
                    Giá thực
                </th>
                <th id="columnScroll" style="width: 16px;">
                </th>
            </tr>
            
        </tbody>
    </table>

       @using (Html.BeginForm("ExportExcel", "SanPham", FormMethod.Post,
        new { @id = "formContent", enctype = "multipart/form-data" }))
        
    {
        <div class="mainContentScroll">
            <table id="tableContent" class="tableContentScroll">          
                <tbody >                          
                </tbody>
            </table>
        </div>
    <input type="hidden" id="ListProductID" name="ListProductID" value="" />
    }
</div>
<hr />
<div>
    @*<input type="button" id="exportExcel" style="width:100px" value="Xuất Excel" onclick="exportExcel();" />*@
    <input type="button" id="createBill" style="width:100px" value="Lập hóa đơn" onclick="CreateBill();">
    <input type="button" style="width:100px" value="Trở về" onclick="location.href='@Url.Action("Index", "SanPham")'" />
</div>

